# システムパターン

**コアアーキテクチャ:**

- **`codex-rs`:** 主要な Rust ロジックを含む。内容は以下の通り:
  - エージェントの推論、実行サンドボックス化、OS/ファイルシステムとの対話。
  - **`mcp-types` クレート:** MCP プロトコルデータ構造を定義。公式 JSON スキーマから Python スクリプト経由で生成。
  - **`mcp-server` クレート:** 基本的な MCP サーバー実装を提供（テスト用など）。
- **`codex-cli`:** コマンドラインインターフェースを提供 (Node.js/TypeScript)。ユーザーインタラクション、プロンプトを管理し、`codex-rs` コンポーネントへの呼び出しを調整し、**MCP クライアント実装** を格納する。
- **言語モデル:** OpenAI API または互換性のある代替（Gemini, Ollama など）と対話する。

**主要な技術的決定:**

- **ハイブリッド言語スタック:** コアロジック/パフォーマンスには Rust、CLI およびクライアントサイドの MCP 統合には Node.js/TypeScript を使用。
- **MCP 型生成:** Python スクリプト (`generate_mcp_types.py`) を使用して公式 MCP JSON スキーマから Rust 型 (`mcp-types`) を生成し、プロトコル準拠を保証。
- **セキュリティのためのサンドボックス化:** AI によって生成または要求されたコードを安全に実行するために、OS 固有のサンドボックス化メカニズム（macOS では Apple Seatbelt、Linux では Docker 推奨）を採用。デフォルトでネットワークアクセスとファイルシステム書き込みを制限。
- **PNPM ワークスペース:** プロジェクトの異なる部分（例: `codex-cli`、共有ユーティリティの可能性）間の依存関係とリンクを管理。
- **Nix Flakes:** 再現可能な開発環境を保証するために使用。
- **設定:** 主に環境変数 (`OPENAI_API_KEY` など) および `.env` ファイル経由。CLI フラグや設定ファイル（指示用の `codex.md`、その他可能性あり）による追加設定も可能。
- **拡張性（計画中）:** Model Context Protocol (MCP) のサポートを追加し、広範な外部ツールやデータソースとの対話を可能にする。
